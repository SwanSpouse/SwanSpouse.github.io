---
title: 短信网关迁移
date: 2018-09-12 23:46:41
tags:
  - business logic
---

### TODO list

首先说清任务需求和难点。

然后解决办法。

遇到的问题。

整理url这一些列，还是有urlencode decode 加密解密 这些业务逻辑

这个等我解决完一切问题再说吧。

或者可以简单把lain说一下。自动化部署 构建这一套流程。CI流程。

### 短信网关迁移

#### 任务概述

因为用户投诉过多。国都通道停掉了好多金融理财平台的营销短信通道，所以只好对接一个新的短信通道。加之原有的短信通道已经升级成3.0，但现有短信平台没有升级（2.0可以正常使用，就没有升级成3.0）。所以借此机会，对接一个新的短信通道+升级原有的短信通道。

原有的短信通道项目是个Java项目，也借此机会把这个项目重构成golang项目。

#### 任务目标

1. 保证功能不变的情况下，将原有用golang进行重构。
2. 对接新的短信通道。
3. 升级原有2.0短信通道为3.0。3.0版本增加了回调接口和心跳。能够查询短信下发状态同时提高了短信网关的可用性。

重构完成后上线后，新老网关同时存在。在nginx上开放一定的流量（10%e.g.）运行一段时间。保证稳定运行后，逐渐放开流量入口，直至最后100%流量全部转移至新短信网关。旧版短信网关下线。

#### 任务难点

1. 保证新旧网关的加密、解密，编码、解码、求取Hash值等方式完全一致。这个是前提。
2. 保证新旧网关的逻辑保持一致。e.g. 在旧网关发送的验证码可以在新网关内进行验证，调用方对使用哪类网关无感知。

ps: Java Hash值计算方式较为复杂。这个可以暂时两端不同。HashCode在项目中的作用主要是用来判断短信内容是否重复。防止段时间内对用户进行多次发送。

#### 实现流程

1. 了解原有网关的代码和接口文档，对主要流程进行梳理。
2. 编写httpClient客户端，根据项目中的短信发送需求，向旧短信网关发送请求，同时记录返回值。形成mock test。要求覆盖主要正常、异常流程。
3. 用golang实现新的短信网关。
4. 利用步骤二中的mock test对新短信网关进行测试。保证主要流程的输入输出一致。
5. 测试无问题后，首先利用离线任务对新短信网关进行测试。单发、群发营销短信。
6. 新短信网关上线，开放10%流量。
7. 迭代并逐步放开流量到100%，稳定后，替换旧短信网关。

### URL地址解释

![url](https://s1.ax1x.com/2018/09/14/iEkq5d.png)

scheme,protocol: 指定因特网服务的类型。例如:HTTP,FTP
host:   指定此域名中的主机。HTTP默认主机是www
port:   指定主机的端口号。HTTP默认端口号是80
path:   指定远端服务器上的路径。默认被指定到网站的根目录。
file:   指定远端服务器上的文件。
extension: 远端服务器上的文件格式。例如.html
query:  请求所携带的参数

#### golang 中解析url的各种方法







### reference
